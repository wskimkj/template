<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ìƒë‹´ ë©”í¬ë¡œ ìŠ¤íŠœë””ì˜¤ Â· Macro Studio</title>
  <style>
    /* === ì—¬ê¸°ê¹Œì§€ëŠ” ê¸°ì¡´ CSS ê·¸ëŒ€ë¡œ === */
    * { box-sizing: border-box; }
    body {
      margin: 0;
      padding: 24px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", system-ui, sans-serif;
      background:
        radial-gradient(circle at top left, #e0f2fe 0, transparent 50%),
        radial-gradient(circle at bottom right, #f5d0fe 0, transparent 55%),
        #f3f4f6;
      display: flex;
      justify-content: center;
    }
    .app { /* ... ìƒëµ (ì§€ê¸ˆ ì˜¬ë¦° CSS ê·¸ëŒ€ë¡œ ë‘ì‹œë©´ ë©ë‹ˆë‹¤) ... */ }
    /* ë‚˜ë¨¸ì§€ CSSëŠ” ì§ˆë¬¸ì— ì˜¬ë ¤ì£¼ì‹  ê·¸ëŒ€ë¡œ ë‘¬ë„ ë¨ */

    /* ğŸ”§ ë¯¸ë¦¬ë³´ê¸° ë²„ë¸” ë¶€ë¶„ë§Œ ì˜ˆì‹œë¡œ ë‚¨ê¹€ */
    .preview-bubble {
      position: absolute;
      top: 42px;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      max-height: 100px;
      background: rgba(15, 23, 42, 0.96);
      color: #e5e7eb;
      border-radius: 14px;
      padding: 8px 10px;
      box-shadow:
        0 16px 32px rgba(15, 23, 42, 0.8),
        0 0 0 1px rgba(148, 163, 184, 0.6);
      font-size: 12px;
      backdrop-filter: blur(12px);
      z-index: 10;
      display: none;
      pointer-events: none;
    }
    .preview-title {
      font-weight: 600;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .preview-body {
      font-size: 12px;
      line-height: 1.5;
      max-height: 65px;
      overflow: auto;
      white-space: pre-wrap;
      color: #e5e7eb;
    }

    @media (max-width: 900px) {
      body { padding: 12px; }
      .app { padding: 16px 14px 16px; max-height: none; }
      .app-body { grid-template-columns: 1fr; }
      .editor-panel { min-height: 260px; }
      .preview-bubble { width: 90%; }
    }
  </style>
</head>
<body>
  <!-- ğŸ”¹ ì‹¤ì œ í™”ë©´ì„ ê·¸ë¦¬ëŠ” ë¶€ë¶„ -->
  <div class="app">
    <header class="app-header">
      <div class="app-title-wrap">
        <div class="app-title-row">
          <span class="app-title-emoji">ğŸ’¬</span>
          <span class="app-title">ìƒë‹´ ë©”í¬ë¡œ ìŠ¤íŠœë””ì˜¤</span>
          <span class="app-tag">Google Sheets ì—°ë™</span>
        </div>
        <div class="app-subtitle">ìƒë‹´ ë‹µë³€ ë©”í¬ë¡œë¥¼ ê²€ìƒ‰ Â· ë¯¸ë¦¬ë³´ê¸° Â· í¸ì§‘ Â· ë³µì‚¬í•˜ëŠ” ê³µê°„ì…ë‹ˆë‹¤.</div>
      </div>
      <div class="header-actions">
        <button class="sheet-button" id="sheetOpenBtn" type="button">
          <span class="icon">ğŸ“„</span>
          <span>ì‹œíŠ¸ ì—´ê¸°</span>
        </button>
        <div class="sheet-caption">êµ¬ê¸€ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ì—ì„œ ë©”í¬ë¡œë¥¼ ê´€ë¦¬í•˜ì„¸ìš”</div>
      </div>
    </header>

    <div class="search-box">
      <input id="searchInput" class="search-input" placeholder="í‚¤ì›Œë“œë¡œ ë©”í¬ë¡œë¥¼ ê²€ìƒ‰í•´ ë³´ì„¸ìš”" />
      <button id="searchButton" class="search-button" type="button">
        <span class="icon">ğŸ”</span>
        <span>ê²€ìƒ‰</span>
      </button>
    </div>

    <div class="top-row">
      <div class="result-count" id="resultCount">ì´ <strong>0</strong>ê°œ ë©”í¬ë¡œ</div>
      <div class="category-filter">
        <span>ì¹´í…Œê³ ë¦¬</span>
        <select id="categorySelect" class="category-select">
          <option value="">ì „ì²´</option>
        </select>
      </div>
    </div>

    <main class="app-body">
      <!-- ì™¼ìª½: ëª©ë¡ íŒ¨ë„ -->
      <section class="list-panel">
        <div class="list-header">
          <div class="list-title">
            <span class="icon">ğŸ“š</span>
            <span>ë©”í¬ë¡œ ëª©ë¡</span>
          </div>
          <div class="list-hint">í•­ëª© ìœ„ì— ë§ˆìš°ìŠ¤ë¥¼ ì˜¬ë¦¬ë©´ ë¯¸ë¦¬ë³´ê¸°ê°€ ëœ¹ë‹ˆë‹¤</div>
        </div>

        <!-- ë¯¸ë¦¬ë³´ê¸° ë²„ë¸” -->
        <div id="previewBubble" class="preview-bubble">
          <div class="preview-title">
            <span class="icon">ğŸ‘€</span>
            <span id="previewTitleText">ë¯¸ë¦¬ë³´ê¸°</span>
          </div>
          <div id="previewBodyText" class="preview-body"></div>
        </div>

        <!-- ê²€ìƒ‰ ê²°ê³¼ ë¦¬ìŠ¤íŠ¸ -->
        <div id="results" class="results"></div>
      </section>

      <!-- ì˜¤ë¥¸ìª½: ì—ë””í„° íŒ¨ë„ -->
      <section class="editor-panel">
        <div class="editor-header">
          <div class="editor-title-wrap">
            <div class="editor-label">ACTIVE MACRO</div>
            <div class="editor-title-line">
              <div id="editorTitle">(ë©”í¬ë¡œë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”)</div>
              <span id="editorCategory" style="display:none;"></span>
            </div>
            <div id="editorMeta" class="editor-hint">ì¢Œì¸¡ ë¦¬ìŠ¤íŠ¸ì—ì„œ ë©”í¬ë¡œë¥¼ ì„ íƒí•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
            <div class="snippet-controls">
              <span class="snippet-label">ë‹¨ì¶•ì‚½ì…</span>
              <button class="snippet-btn" type="button" data-snippet="header">
                <span class="icon">â¬†ï¸</span><span>ë¨¸ë¦¬ë§</span>
              </button>
              <button class="snippet-btn" type="button" data-snippet="footer">
                <span class="icon">â¬‡ï¸</span><span>ê¼¬ë¦¬ë§</span>
              </button>
              <button class="snippet-btn" type="button" data-snippet="apology">
                <span class="icon">ğŸ™</span><span>ì‚¬ê³¼ ë¬¸êµ¬</span>
              </button>
            </div>
          </div>
          <div class="editor-actions">
            <button id="editorCopyBtn" class="copy-main" type="button" disabled>
              <span class="icon">ğŸ“‹</span>
              <span>ì „ì²´ ë³µì‚¬</span>
            </button>
            <button id="editorResetBtn" class="reset-btn" type="button" disabled>ì›ë³¸ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°</button>
          </div>
        </div>

        <textarea
          id="editorTextarea"
          class="editor-textarea"
          placeholder="ì¢Œì¸¡ì—ì„œ ë©”í¬ë¡œë¥¼ ì„ íƒí•˜ë©´ ë‚´ìš©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤."
          disabled
        ></textarea>

        <div class="editor-footer">
          <span id="charCount">0ì</span>
          <span>ë³µì‚¬ í›„ ë°”ë¡œ ìƒë‹´ì°½ì— ë¶™ì—¬ë„£ì–´ ì‚¬ìš©í•´ ì£¼ì„¸ìš”.</span>
        </div>
      </section>
    </main>
  </div>

  <!-- í† ìŠ¤íŠ¸ -->
  <div id="toast" class="toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤</div>

  <!-- ğŸ”¹ JSëŠ” HTML ë’¤ìª½ì— -->
  <script>
    const SHEET_ID = "1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM";
    const SHEET_GID = "1260123292";
    const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
    const SHEET_LINK = "https://docs.google.com/spreadsheets/d/1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM/edit?gid=1260123292#gid=1260123292";

    const DEFAULT_HEADER = "ì•ˆë…•í•˜ì„¸ìš” í™”ì´íŠ¸ìƒŒì¦ˆì…ë‹ˆë‹¤.";
    const DEFAULT_FOOTER = "í™”ì´íŠ¸ìƒŒì¦ˆë¥¼ ì°¾ì•„ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.";
    const DEFAULT_APOLOGY = "ë” ì¢‹ì€ ìƒí’ˆê³¼ ì„œë¹„ìŠ¤ë¡œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.";

    let macros = [];
    let filteredMacros = [];
    let activeMacro = null;
    let toastTimer = null;

    function parseCSV(text) {
      const rows = [];
      let row = [];
      let cur = "";
      let insideQuotes = false;

      for (let i = 0; i < text.length; i++) {
        const char = text[i];
        const next = text[i + 1];

        if (char === '"' && insideQuotes && next === '"') {
          cur += '"';
          i++;
        } else if (char === '"') {
          insideQuotes = !insideQuotes;
        } else if (char === "," && !insideQuotes) {
          row.push(cur);
          cur = "";
        } else if ((char === "\n" || char === "\r") && !insideQuotes) {
          if (cur.length > 0 || row.length > 0) {
            row.push(cur);
            rows.push(row);
            row = [];
            cur = "";
          }
        } else {
          cur += char;
        }
      }
      if (cur.length > 0 || row.length > 0) {
        row.push(cur);
        rows.push(row);
      }
      return rows;
    }

    async function loadMacrosFromSheet() {
      try {
        const res = await fetch(CSV_URL);
        const text = await res.text();
        const rows = parseCSV(text);
        const dataRows = rows.slice(1);

        macros = dataRows
          .map((cols, idx) => {
            const title = (cols[0] || "").trim();
            const category = (cols[1] || "").trim();
            const content = (cols[2] || "").trim();
            if (!title && !content) return null;
            return { id: `macro-${idx}`, title, category, content };
          })
          .filter(Boolean);

        filteredMacros = macros.slice();
        initCategoryOptions();
        renderResults(filteredMacros);
      } catch (e) {
        console.error(e);
        alert("êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ê³µìœ  ì„¤ì •ê³¼ URLì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.");
      }
    }

    // ğŸ”¹ ì—¬ê¸°ì„œë¶€í„°ëŠ” ì§ˆë¬¸ì— ì˜¬ë¦¬ì‹  JS ê±°ì˜ ê·¸ëŒ€ë¡œ
    const searchInput = document.getElementById("searchInput");
    const searchButton = document.getElementById("searchButton");
    const resultsEl = document.getElementById("results");
    const resultCountEl = document.getElementById("resultCount");
    const categorySelect = document.getElementById("categorySelect");

    const editorTitleEl = document.getElementById("editorTitle");
    const editorCategoryEl = document.getElementById("editorCategory");
    const editorTextarea = document.getElementById("editorTextarea");
    const editorCopyBtn = document.getElementById("editorCopyBtn");
    const editorResetBtn = document.getElementById("editorResetBtn");
    const editorMetaEl = document.getElementById("editorMeta");
    const charCountEl = document.getElementById("charCount");

    const toastEl = document.getElementById("toast");

    const previewBubbleEl = document.getElementById("previewBubble");
    const previewTitleTextEl = document.getElementById("previewTitleText");
    const previewBodyTextEl = document.getElementById("previewBodyText");

    const sheetOpenBtn = document.getElementById("sheetOpenBtn");
    const snippetButtons = document.querySelectorAll(".snippet-btn");

    sheetOpenBtn.addEventListener("click", () => {
      window.open(SHEET_LINK, "_blank", "noopener");
    });

    function initCategoryOptions() {
      while (categorySelect.options.length > 1) {
        categorySelect.remove(1);
      }

      const categories = Array.from(
        new Set(
          macros
            .map((m) => (m.category || "").trim())
            .filter((c) => c.length > 0)
        )
      ).sort();

      categories.forEach((cat) => {
        const opt = document.createElement("option");
        opt.value = cat;
        opt.textContent = cat;
        categorySelect.appendChild(opt);
      });
    }

    function searchMacros() {
      const query = searchInput.value.trim().toLowerCase();
      const selectedCategory = categorySelect.value;

      filteredMacros = macros;

      if (selectedCategory) {
        filteredMacros = filteredMacros.filter(
          (m) => (m.category || "").trim() === selectedCategory
        );
      }

      if (query) {
        filteredMacros = filteredMacros.filter((m) => {
          const title = (m.title || "").toLowerCase();
          const content = (m.content || "").toLowerCase();
          return title.includes(query) || content.includes(query);
        });
      }

      renderResults(filteredMacros);
      hidePreview();
    }

    function renderResults(list) {
      resultsEl.innerHTML = "";
      resultCountEl.innerHTML = `ì´ <strong>${list.length}</strong>ê°œ ë©”í¬ë¡œ`;

      if (list.length === 0) {
        const empty = document.createElement("div");
        empty.className = "empty-state";
        empty.textContent = "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. í‚¤ì›Œë“œë¥¼ ë°”ê¿”ì„œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
        resultsEl.appendChild(empty);
        return;
      }

      list.forEach((macro) => {
        const item = document.createElement("div");
        item.className = "macro-item";
        item.dataset.id = macro.id;

        if (activeMacro && activeMacro.id === macro.id) {
          item.classList.add("active");
        }

        const header = document.createElement("div");
        header.className = "macro-header";

        const titleWrap = document.createElement("div");
        titleWrap.className = "macro-title";
        titleWrap.textContent = macro.title || "(ì œëª© ì—†ìŒ)";

        if (macro.category) {
          const cat = document.createElement("span");
          cat.className = "macro-category";
          cat.textContent = macro.category;
          titleWrap.appendChild(cat);
        }

        const miniCopy = document.createElement("button");
        miniCopy.className = "copy-mini";
        miniCopy.type = "button";
        miniCopy.innerHTML = `<span class="icon">ğŸ“‹</span><span>ì›ë³¸</span>`;
        miniCopy.addEventListener("click", (e) => {
          e.stopPropagation();
          copyToClipboard(macro.content || "");
        });

        header.appendChild(titleWrap);
        header.appendChild(miniCopy);

        const sub = document.createElement("div");
        sub.className = "macro-subtext";
        const stripped = (macro.content || "").replace(/\s+/g, " ");
        sub.textContent = stripped.slice(0, 60) + (stripped.length > 60 ? "â€¦" : "");

        item.appendChild(header);
        item.appendChild(sub);

        item.addEventListener("click", () => {
          selectMacro(macro);
          document.querySelectorAll(".macro-item").forEach((el) => {
            el.classList.remove("active");
          });
          item.classList.add("active");
        });

        item.addEventListener("mouseenter", () => {
          showPreview(macro);
        });

        resultsEl.appendChild(item);
      });
    }

    resultsEl.addEventListener("mouseleave", hidePreview);

    function selectMacro(macro) {
      activeMacro = { ...macro };

      editorTitleEl.textContent = activeMacro.title || "(ì œëª© ì—†ìŒ)";
      if (activeMacro.category) {
        editorCategoryEl.textContent = activeMacro.category;
        editorCategoryEl.style.display = "inline-block";
      } else {
        editorCategoryEl.style.display = "none";
      }

      editorTextarea.disabled = false;
      editorCopyBtn.disabled = false;
      editorResetBtn.disabled = false;

      editorTextarea.value = activeMacro.content || "";
      updateCharCount();
      editorMetaEl.textContent = "ì„ íƒëœ ë©”í¬ë¡œ í¸ì§‘ ì¤‘";
    }

    function updateCharCount() {
      const len = editorTextarea.value.length;
      charCountEl.textContent = `${len}ì`;
    }

    editorTextarea && editorTextarea.addEventListener("input", updateCharCount);

    function copyToClipboard(text) {
      if (!text) return;

      if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard
          .writeText(text)
          .then(() => showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤"))
          .catch(() => fallbackCopy(text));
      } else {
        fallbackCopy(text);
      }
    }

    function fallbackCopy(text) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      textarea.style.position = "fixed";
      textarea.style.left = "-9999px";
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();

      try {
        document.execCommand("copy");
        showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤");
      } catch (e) {
        alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì§ì ‘ ì„ íƒí•´ì„œ ë³µì‚¬í•´ ì£¼ì„¸ìš”.");
      } finally {
        document.body.removeChild(textarea);
      }
    }

    editorCopyBtn.addEventListener("click", () => {
      const text = editorTextarea.value || "";
      if (!text) return;
      copyToClipboard(text);
    });

    editorResetBtn.addEventListener("click", () => {
      if (!activeMacro) return;
      editorTextarea.value = activeMacro.content || "";
      updateCharCount();
      showToast("ì›ë³¸ìœ¼ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤");
    });

    function showToast(message) {
      toastEl.textContent = message || "ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤";
      toastEl.classList.add("show");
      if (toastTimer) clearTimeout(toastTimer);
      toastTimer = setTimeout(() => {
        toastEl.classList.remove("show");
      }, 1500);
    }

    function showPreview(macro) {
      if (!macro || !macro.content) {
        hidePreview();
        return;
      }
      previewTitleTextEl.textContent = macro.title || "ë¯¸ë¦¬ë³´ê¸°";
      previewBodyTextEl.textContent = macro.content;
      previewBubbleEl.style.display = "block";
    }

    function hidePreview() {
      previewBubbleEl.style.display = "none";
    }

    function applySnippet(type) {
      if (editorTextarea.disabled) return;

      let text = editorTextarea.value || "";
      const trimmed = text.trim();

      if (type === "header") {
        if (trimmed.startsWith(DEFAULT_HEADER)) {
          showToast("ì´ë¯¸ ë¨¸ë¦¬ë§ì´ ë“¤ì–´ê°€ ìˆì–´ìš”");
          return;
        }
        const body = text.replace(/^\s+/, "");
        editorTextarea.value = DEFAULT_HEADER + (body ? "\n\n" + body : "");
      } else if (type === "footer") {
        if (trimmed.endsWith(DEFAULT_FOOTER)) {
          showToast("ì´ë¯¸ ê¼¬ë¦¬ë§ì´ ë“¤ì–´ê°€ ìˆì–´ìš”");
          return;
        }
        const withoutTrailing = text.replace(/\s+$/, "");
        editorTextarea.value = (withoutTrailing ? withoutTrailing + "\n\n" : "") + DEFAULT_FOOTER;
      } else if (type === "apology") {
        if (trimmed.includes("ë” ì¢‹ì€ ìƒí’ˆê³¼ ì„œë¹„ìŠ¤ë¡œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤")) {
          showToast("ì´ë¯¸ ì‚¬ê³¼ ë¬¸êµ¬ê°€ ë“¤ì–´ê°€ ìˆì–´ìš”");
          return;
        }
        const withoutTrailing = text.replace(/\s+$/, "");
        editorTextarea.value = (withoutTrailing ? withoutTrailing + "\n\n" : "") + DEFAULT_APOLOGY;
      }

      updateCharCount();
    }

    snippetButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const type = btn.dataset.snippet;
        applySnippet(type);
      });
    });

    searchButton.addEventListener("click", searchMacros);
    searchInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") searchMacros();
    });
    categorySelect.addEventListener("change", searchMacros);

    // ë§ˆì§€ë§‰ì— ë°ì´í„° ë¡œë“œ
    loadMacrosFromSheet();
  </script>
</body>
</html>
