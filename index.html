<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>ìƒë‹´ ë©”í¬ë¡œ ìŠ¤íŠœë””ì˜¤ Â· Macro Studio</title>
<style>
/* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© */
* { box-sizing: border-box; }
body { margin:0; padding:24px; font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",system-ui,sans-serif; background:radial-gradient(circle at top left,#e0f2fe 0,transparent 50%),radial-gradient(circle at bottom right,#f5d0fe 0,transparent 55%),#f3f4f6; display:flex; justify-content:center; }
.app { width:100%; max-width:1280px; background:rgba(255,255,255,0.96); border-radius:26px; box-shadow:0 20px 60px rgba(15,23,42,0.16),0 0 0 1px rgba(148,163,184,0.2); padding:20px 22px 22px; display:flex; flex-direction:column; gap:12px; backdrop-filter:blur(16px); max-height:calc(100vh - 48px); }
/* ... ê¸°ì¡´ CSSëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ ... */
</style>
</head>
<body>
<div class="app">
  <!-- í—¤ë”, ê²€ìƒ‰ì°½, í•„í„° ë“± ë™ì¼ -->
  <div class="app-header"> ... </div>
  <div class="search-box"> ... </div>
  <div class="top-row"> ... </div>

  <div class="app-body">
    <div class="list-panel">
      <div class="list-header"> ... </div>
      <div id="previewBubble." class="preview-bubble"> ... </div>
      <div id="results" class="results"></div>
    </div>

    <div class="editor-panel"> ... </div>
  </div>
</div>

<div id="toast" class="toast">ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤</div>

<script>
const SHEET_ID = "1_L12NKkBVU4c5xDPrYLUQRnSUG2NoAwYGWIfPDVO3bM";
const SHEET_GID = "1260123292";
const CSV_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${SHEET_GID}`;
const SHEET_LINK = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/edit?gid=${SHEET_GID}`;

const DEFAULT_HEADER = "ì•ˆë…•í•˜ì„¸ìš” í™”ì´íŠ¸ìƒŒì¦ˆì…ë‹ˆë‹¤.";
const DEFAULT_FOOTER = "í™”ì´íŠ¸ìƒŒì¦ˆë¥¼ ì°¾ì•„ì£¼ì…”ì„œ ê°ì‚¬ë“œë¦½ë‹ˆë‹¤.";
const DEFAULT_APOLOGY = "ë” ì¢‹ì€ ìƒí’ˆê³¼ ì„œë¹„ìŠ¤ë¡œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤.\n\nê°ì‚¬í•©ë‹ˆë‹¤.";

let macros = [];
let filteredMacros = [];
let activeMacro = null;
let toastTimer = null;

// CSV íŒŒì„œ (ê¸°ì¡´)
function parseCSV(text) {
  const rows=[]; let row=[]; let cur=""; let insideQuotes=false;
  for(let i=0;i<text.length;i++){
    const char=text[i]; const next=text[i+1];
    if(char=='"' && insideQuotes && next=='"'){ cur+='"'; i++; }
    else if(char=='"'){ insideQuotes=!insideQuotes; }
    else if(char==',' && !insideQuotes){ row.push(cur); cur=""; }
    else if((char=='\n'||char=='\r')&&!insideQuotes){ if(cur.length>0||row.length>0){ row.push(cur); rows.push(row); row=[]; cur=""; } }
    else{ cur+=char; }
  }
  if(cur.length>0||row.length>0){ row.push(cur); rows.push(row); }
  return rows;
}

// êµ¬ê¸€ ì‹œíŠ¸ì—ì„œ ë°ì´í„° ë¡œë“œ
async function loadMacrosFromSheet(){
  try{
    const res = await fetch(CSV_URL);
    const text = await res.text();
    const rows = parseCSV(text);
    const dataRows = rows.slice(1);

    macros = dataRows.map((cols, idx)=>{
      const title = (cols[0]||"").trim();
      const category = (cols[1]||"").trim();
      const subcategory = (cols[2]||"").trim();
      const content = (cols[3]||"").trim();
      if(!title && !content) return null;
      return { id:`macro-${idx}`, title, category, subcategory, content };
    }).filter(Boolean);

    filteredMacros = macros.slice();
    initCategoryOptions();
    renderResults(filteredMacros);
  }catch(e){ console.error(e); alert("êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤."); }
}

// DOM ìš”ì†Œ
const searchInput=document.getElementById("searchInput");
const searchButton=document.getElementById("searchButton");
const resultsEl=document.getElementById("results");
const resultCountEl=document.getElementById("resultCount");
const categorySelect=document.getElementById("categorySelect");

const editorTitleEl=document.getElementById("editorTitle");
const editorCategoryEl=document.getElementById("editorCategory");
const editorTextarea=document.getElementById("editorTextarea");
const editorCopyBtn=document.getElementById("editorCopyBtn");
const editorResetBtn=document.getElementById("editorResetBtn");
const editorMetaEl=document.getElementById("editorMeta");
const charCountEl=document.getElementById("charCount");

const toastEl=document.getElementById("toast");

const previewBubbleEl=document.getElementById("previewBubble");
const previewTitleTextEl=document.getElementById("previewTitleText");
const previewBodyTextEl=document.getElementById("previewBodyText");

const sheetOpenBtn=document.getElementById("sheetOpenBtn");
const snippetButtons=document.querySelectorAll(".snippet-btn");
const listPanelEl=document.querySelector(".list-panel");

// ì‹œíŠ¸ ì—´ê¸°
sheetOpenBtn.addEventListener("click",()=>{ window.open(SHEET_LINK,"_blank","noopener"); });

// ì¹´í…Œê³ ë¦¬ ì˜µì…˜
function initCategoryOptions(){
  while(categorySelect.options.length>1) categorySelect.remove(1);
  const categories = Array.from(new Set(macros.map(m=>m.category||"").filter(c=>c))).sort();
  categories.forEach(cat=>{
    const opt=document.createElement("option"); opt.value=cat; opt.textContent=cat;
    categorySelect.appendChild(opt);
  });
}

// ğŸ”¹ ê²€ìƒ‰: ì†Œë¶„ë¥˜ë§Œ ì°¸ì¡°
function searchMacros(){
  const query = searchInput.value.trim().toLowerCase();
  const selectedCategory = categorySelect.value;
  filteredMacros = macros;

  if(selectedCategory){
    filteredMacros = filteredMacros.filter(m => (m.category||"").trim()===selectedCategory);
  }

  if(query){
    filteredMacros = filteredMacros.filter(m => (m.subcategory||"").toLowerCase().includes(query));
  }

  renderResults(filteredMacros);
  hidePreview();
}

  // ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
searchButton.addEventListener("click", searchMacros);

// ì—”í„° ì…ë ¥ ì´ë²¤íŠ¸
searchInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") searchMacros();
});

// ğŸ”¹ ì‹¤ì‹œê°„ ì…ë ¥ ì´ë²¤íŠ¸ ì¶”ê°€
searchInput.addEventListener("input", searchMacros);

// ì¹´í…Œê³ ë¦¬ ì„ íƒ ë³€ê²½ ì‹œ
categorySelect.addEventListener("change", searchMacros);

// ë¦¬ìŠ¤íŠ¸ ë Œë”ë§ (ê¸°ì¡´)
function renderResults(list){
  resultsEl.innerHTML="";
  resultCountEl.innerHTML=`ì´ <strong>${list.length}</strong>ê°œ ë©”í¬ë¡œ`;
  if(list.length===0){
    const empty=document.createElement("div");
    empty.className="empty-state";
    empty.textContent="ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. í‚¤ì›Œë“œë¥¼ ë°”ê¿”ì„œ ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”.";
    resultsEl.appendChild(empty);
    return;
  }

list.forEach((macro) => {
  const item = document.createElement("div");
  item.className = "macro-item";
  item.dataset.id = macro.id;

  // ì•„ì´í…œ í´ë¦­ ì‹œ active
  if (activeMacro && activeMacro.id === macro.id) {
    item.classList.add("active");
  }

  const header = document.createElement("div");
  header.className = "macro-header";

  // ğŸ”¹ ì œëª© = í…œí”Œë¦¿ ë‚´ìš©(D)
  const titleWrap = document.createElement("div");
  titleWrap.className = "macro-title";
  titleWrap.textContent = macro.content || "(ë‚´ìš© ì—†ìŒ)";

  // ğŸ”¹ ëŒ€ë¶„ë¥˜ ë²„íŠ¼(B)
  if (macro.category) {
    const catBtn = document.createElement("span");
    catBtn.className = "macro-category"; // ê¸°ì¡´ ìŠ¤íƒ€ì¼ ê·¸ëŒ€ë¡œ ì‚¬ìš© ê°€ëŠ¥
    catBtn.style.background = "#eef2ff"; // íŒŒë‘ ë°°ê²½
    catBtn.style.color = "#4f46e5";      // ê¸€ì íŒŒë‘
    catBtn.textContent = macro.category; // Bì—´
    titleWrap.appendChild(catBtn);
  }

  // ğŸ”¹ ì†Œë¶„ë¥˜(C) í‘œì‹œ
  if (macro.subcategory) {
    const subEl = document.createElement("div");
    subEl.className = "macro-subtext";
    subEl.textContent = macro.subcategory; // Cì—´
    item.appendChild(subEl);
  }

  // ì›ë³¸ ë³µì‚¬ ë²„íŠ¼
  const miniCopy = document.createElement("button");
  miniCopy.className = "copy-mini";
  miniCopy.type = "button";
  miniCopy.innerHTML = `<span class="icon">ğŸ“‹</span><span>ì›ë³¸</span>`;
  miniCopy.addEventListener("click", (e) => {
    e.stopPropagation();
    copyToClipboard(macro.content || "");
  });

  header.appendChild(titleWrap);
  header.appendChild(miniCopy);

  item.appendChild(header);

  // í´ë¦­ â†’ í¸ì§‘ì°½
  item.addEventListener("click", () => {
    selectMacro(macro);
    document.querySelectorAll(".macro-item").forEach((el) => {
      el.classList.remove("active");
    });
    item.classList.add("active");
  });

  // í˜¸ë²„ â†’ ë¯¸ë¦¬ë³´ê¸°
  item.addEventListener("mouseenter", () => showPreview(macro, item));
  item.addEventListener("mouseleave", hidePreview);

  resultsEl.appendChild(item);
});


// ë©”í¬ë¡œ ì„ íƒ
function selectMacro(macro){
  activeMacro={...macro};
  editorTitleEl.textContent=activeMacro.title||"(ì œëª© ì—†ìŒ)";
  if(activeMacro.category){ editorCategoryEl.textContent=activeMacro.category; editorCategoryEl.style.display="inline-block"; } 
  else{ editorCategoryEl.style.display="none"; }

  editorTextarea.disabled=false;
  editorCopyBtn.disabled=false;
  editorResetBtn.disabled=false;

  editorTextarea.value=activeMacro.content||"";
  updateCharCount();
  editorMetaEl.textContent="ì„ íƒëœ ë©”í¬ë¡œ í¸ì§‘ ì¤‘";
}

// ê¸€ììˆ˜
function updateCharCount(){ charCountEl.textContent = `${editorTextarea.value.length}ì`; }
editorTextarea && editorTextarea.addEventListener("input", updateCharCount);

// í´ë¦½ë³´ë“œ
function copyToClipboard(text){
  if(!text) return;
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).then(()=>showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤")).catch(()=>fallbackCopy(text));
  }else fallbackCopy(text);
}
function fallbackCopy(text){
  const ta=document.createElement("textarea"); ta.value=text; ta.style.position="fixed"; ta.style.left="-9999px"; document.body.appendChild(ta);
  ta.focus(); ta.select();
  try{ document.execCommand("copy"); showToast("ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤"); }catch(e){ alert("ë³µì‚¬ ì‹¤íŒ¨"); } finally{ document.body.removeChild(ta); }
}
editorCopyBtn.addEventListener("click",()=>copyToClipboard(editorTextarea.value||""));

// ì›ë³¸ìœ¼ë¡œ ë˜ëŒë¦¬ê¸°
editorResetBtn.addEventListener("click",()=>{
  if(!activeMacro) return;
  editorTextarea.value=activeMacro.content||"";
  updateCharCount();
  showToast("ì›ë³¸ìœ¼ë¡œ ë˜ëŒë ¸ìŠµë‹ˆë‹¤");
});

// í† ìŠ¤íŠ¸
function showToast(msg){ toastEl.textContent=msg||"ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤"; toastEl.classList.add("show"); if(toastTimer) clearTimeout(toastTimer); toastTimer=setTimeout(()=>toastEl.classList.remove("show"),1500); }

// ë¯¸ë¦¬ë³´ê¸°
function showPreview(macro,anchorEl){
  if(!macro||!macro.content||!anchorEl){ hidePreview(); return; }
  previewTitleTextEl.textContent=macro.title||"ë¯¸ë¦¬ë³´ê¸°";
  previewBodyTextEl.textContent=macro.content;
  previewBubbleEl.style.display="block"; previewBubbleEl.style.opacity="0";
  const anchorRect=anchorEl.getBoundingClientRect(); const panelRect=listPanelEl.getBoundingClientRect();
  const bubbleHeight=previewBubbleEl.offsetHeight||160;
  let top = anchorRect.top-panelRect.top+anchorRect.height/2-bubbleHeight/2;
  const minTop=40; const maxTop=listPanelEl.clientHeight-bubbleHeight-16;
  top=Math.max(minTop,Math.min(top,maxTop));
  previewBubbleEl.style.top=`${top}px`; previewBubbleEl.style.opacity="1"; previewBubbleEl.classList.add("visible");
}
function hidePreview(){ previewBubbleEl.classList.remove("visible"); previewBubbleEl.style.display="none"; }

// ê¸°ë³¸ ë¬¸êµ¬
function applySnippet(type){
  if(editorTextarea.disabled) return;
  let text = editorTextarea.value || "";
  const trimmed = text.trim();
  if(type==="header"){
    if(trimmed.startsWith(DEFAULT_HEADER)){ showToast("ì´ë¯¸ ë¨¸ë¦¬ë§ì´ ë“¤ì–´ê°€ ìˆì–´ìš”"); return; }
    const body=text.replace(/^\s+/,""); editorTextarea.value=DEFAULT_HEADER+(body? "\n\n"+body:"");
  }else if(type==="footer"){
    if(trimmed.endsWith(DEFAULT_FOOTER)){ showToast("ì´ë¯¸ ê¼¬ë¦¬ë§ì´ ë“¤ì–´ê°€ ìˆì–´ìš”"); return; }
    const withoutTrailing=text.replace(/\s+$/,""); editorTextarea.value=(withoutTrailing?withoutTrailing+"\n\n":"")+DEFAULT_FOOTER;
  }else if(type==="apology"){
    if(trimmed.includes("ë” ì¢‹ì€ ìƒí’ˆê³¼ ì„œë¹„ìŠ¤ë¡œ ì°¾ì•„ëµ™ê² ìŠµë‹ˆë‹¤")){ showToast("ì´ë¯¸ ì‚¬ê³¼ ë¬¸êµ¬ê°€ ë“¤ì–´ê°€ ìˆì–´ìš”"); return; }
    const withoutTrailing=text.replace(/\s+$/,""); editorTextarea.value=(withoutTrailing?withoutTrailing+"\n\n":"")+DEFAULT_APOLOGY;
  }
  updateCharCount();
}
snippetButtons.forEach(btn=>btn.addEventListener("click",()=>applySnippet(btn.dataset.snippet)));

// ì´ë²¤íŠ¸
searchButton.addEventListener("click",searchMacros);
searchInput.addEventListener("keydown",e=>{ if(e.key==="Enter") searchMacros(); });
categorySelect.addEventListener("change",searchMacros);

// ì´ˆê¸° ë¡œë“œ
loadMacrosFromSheet();

</script>
</body>
</html>
